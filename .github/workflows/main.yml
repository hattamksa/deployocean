name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: hatta1212/digitalpathocean
  CONTAINER_NAME: digitalpathocean
  APP_PORT: 3000
  HOST_PORT: 3000

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Docker Tag
        id: vars
        run: |
          echo "DOCKER_TAG=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.vars.outputs.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

      - name: Copy .env file to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: ".env.production"
          target: "/var/www/${{ env.CONTAINER_NAME }}/"
          strip_components: 0

      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: DOCKER_IMAGE,CONTAINER_NAME,APP_PORT,HOST_PORT
          script: |
            set -e
            
            cd /var/www/${{ env.CONTAINER_NAME }}
            
            # Rename .env.production to .env
            mv .env.production .env || true
            
            DOCKER_TAG=${{ steps.vars.outputs.DOCKER_TAG }}
            
            echo "=== Pull new image ==="
            docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
            
            echo "=== Stop old container (if exists) ==="
            docker stop ${CONTAINER_NAME} || true
            
            echo "=== Remove old container (if exists) ==="
            docker rm ${CONTAINER_NAME} || true
            
            echo "=== Waiting for container cleanup... 10 seconds ==="
            sleep 10
            
            echo "=== Remove old images (if any) ==="
            old_images=$(docker images --format "{{.Repository}}:{{.Tag}}" \
                | grep "^${DOCKER_IMAGE}:" \
                | grep -v "^${DOCKER_IMAGE}:${DOCKER_TAG}$" \
                | grep -v "^${DOCKER_IMAGE}:latest$" || true)
            
            if [[ -n "$old_images" ]]; then
              echo "Found old images to remove:"
              echo "$old_images"
              
              while read -r img; do
                if [[ -n "$img" && "$img" != "<none>:<none>" ]]; then
                  docker rmi -f "$img" || true
                fi
              done <<< "$old_images"
            else
              echo "No old images to remove."
            fi
            
            echo "=== Run new container ==="
            docker run -d \
              --env-file .env \
              -p ${HOST_PORT}:${APP_PORT} \
              --restart unless-stopped \
              --name ${CONTAINER_NAME} \
              ${DOCKER_IMAGE}:${DOCKER_TAG}
            
            echo "=== Waiting for container to be ready ==="
            sleep 5
            
            echo "=== Container status ==="
            docker ps | grep ${CONTAINER_NAME}
            
            echo "=== Remove .env file from server ==="
            rm .env
            
            echo "=== Deployment completed successfully! ==="

      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            echo "=== Checking container health ==="
            docker ps -a | grep ${{ env.CONTAINER_NAME }}
            
            echo "=== Checking container logs (last 20 lines) ==="
            docker logs --tail 20 ${{ env.CONTAINER_NAME }}
            
            echo "=== Testing HTTP endpoint ==="
            curl -f http://localhost:${{ env.HOST_PORT }} || echo "Warning: HTTP check failed"

      - name: Notification on Success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.vars.outputs.DOCKER_TAG }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          
      - name: Notification on Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details"
